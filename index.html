<!doctype html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#111827">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="stylesheet" href="/styles.css">
  <title>Constrivia</title>
</head>
<body class="theme-dark">
  <div class="app">
    <div class="toolbar toolbar-bare toolbar-top">
      <div class="tool-row">
        <div class="topbar-left">
        <div class="dropdown" id="styleMenuContainer" style="display:none;">
          <button id="styleMenu" class="tool icon-btn icon-btn-ghost" title="Styl zaznaczenia" aria-label="Styl zaznaczenia">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="menu-dots"></svg>
          </button>
          <div class="dropdown-menu" style="width:100%; box-sizing:border-box;">
            <div class="tool-row style-line-row" id="styleEdgesRow" style="justify-content:flex-start;">
              <div class="style-group" id="styleVerticesGroup">
                <button class="tool icon-btn" id="viewVerticesOption" title="Wierzchołki">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="view-vertices"></svg>
                </button>
                <button class="tool icon-btn" id="viewEdgesOption" title="Krawędzie">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="view-edges"></svg>
                </button>
              </div>
              <div class="style-group" id="styleTickGroup" style="display:none;">
                <button type="button" class="tool icon-btn tick-btn" id="styleTickToggle" title="Znacznik zgodności" aria-label="Znacznik zgodności" aria-pressed="false">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="tick-1"></svg>
                </button>
              </div>
              <div class="style-group" id="styleRayGroup">
                <button class="tool icon-btn" id="rayLeftOption" title="Lewa półprosta">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="ray-left-point"></svg>
                </button>
                <button class="tool icon-btn" id="rayRightOption" title="Prawa półprosta">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="ray-right-point"></svg>
                </button>
                <button class="tool icon-btn" id="raySegmentOption" title="Odcinek">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="ray-segment"></svg>
                </button>
              </div>
              <button class="tool icon-btn" id="polygonLockToggleBtn" title="Blokada ksztaltu" aria-label="Blokada ksztaltu" aria-pressed="false" style="display:none;">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="lock"></svg>
              </button>
            </div>
            <div class="tool-row style-line-row" id="styleCircleRow" style="justify-content:flex-start; display:none;">
              <div class="style-group" id="styleCircleGroup">
                <button class="tool icon-btn" id="viewCirclePointsOption" title="Punkty">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="view-vertices"></svg>
                </button>
                <button class="tool icon-btn" id="viewCircleLineOption" title="Okrąg">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="circle-outline"></svg>
                </button>
              </div>
            </div>
            <input type="color" id="styleColor" value="#15a3ff" style="display:none">
            <div class="tool-row" id="styleColorRow" style="justify-content:flex-start; gap:6px; margin-bottom:4px;">
              <button class="tool icon-btn color-btn" data-slot="0" title="Kolor 1"></button>
              <button class="tool icon-btn color-btn" data-slot="1" title="Kolor 2"></button>
              <button class="tool icon-btn color-btn" data-slot="2" title="Kolor 3"></button>
              <button class="tool icon-btn color-btn" data-slot="3" title="Kolor 4"></button>
              <button class="tool icon-btn color-btn" data-slot="4" title="Kolor 5"></button>
              <button class="tool icon-btn color-btn custom-color-btn" id="customColorBtn" title="Inny kolor">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="color-custom"></svg>
              </button>
              <button class="tool icon-btn" id="pointHollowToggleBtn" title="Pusty punkt" aria-label="Pusty punkt" aria-pressed="false" style="display:none;">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="point-hollow"></svg>
              </button>
              <button class="tool icon-btn" id="exteriorAngleBtn" title="Kąt wklęsły" aria-label="Kąt wklęsły" aria-pressed="false" style="display:none;">
                <svg class="icon" viewBox="0 0 100 100" aria-hidden="true" data-icon="angle-exterior"></svg>
              </button>
                <button class="tool icon-btn" id="fillToggleBtn" title="Wypełnienie" aria-label="Wypełnienie" aria-pressed="false" style="display:none; position:relative;">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="fill-rect"></svg>
                  <span class="fill-perc" aria-hidden="true"></span>
                </button>
                <button id="highlighterBtn" class="tool icon-btn" title="Podświetlacz" aria-label="Podświetlacz" aria-pressed="false" style="display:none;">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="highlighter"></svg>
                </button>
            </div>
            <div class="tool-row custom-color-row" id="customColorRow" style="justify-content:flex-start; align-items:center; gap:8px; display:none;">
              <label for="customColorInput">Kolor</label>
              <input type="color" id="customColorInput" value="#15a3ff">
              <label for="customColorAlpha">Przezroczystosc</label>
              <input type="range" id="customColorAlpha" min="0" max="1" step="0.05" value="1" style="flex:1;">
              <span id="customColorAlphaValue" class="custom-color-alpha-value">100%</span>
            </div>
            <div class="tool-row" id="labelTextRow" style="justify-content:flex-start; align-items:center; display:none;">
              <label for="labelText">Tekst</label>
              <textarea id="labelText" rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';" style="flex:1; min-width:120px; height:auto; padding:0.25em 0.5em; box-sizing:border-box; overflow:hidden; resize:vertical; font-family: sans-serif;"></textarea>
              <button type="button" id="labelGreekToggle" class="tool icon-btn label-greek-toggle" title="Klawiatura symboli" aria-label="Klawiatura symboli" aria-pressed="false">Aa</button>
            </div>
            <div class="tool-row label-font-row" id="labelFontRow" style="display:none;">
              <button type="button" class="tool icon-btn label-font-btn" id="labelFontDecrease" title="Zmniejsz rozmiar tekstu" aria-label="Zmniejsz rozmiar tekstu">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="icon-minus"></svg>
              </button>
              <span id="labelFontSizeValue" class="label-font-size" aria-live="polite">12 px</span>
              <button type="button" class="tool icon-btn label-font-btn" id="labelFontIncrease" title="Zwiększ rozmiar tekstu" aria-label="Zwiększ rozmiar tekstu">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="icon-plus"></svg>
              </button>
              <button type="button" class="tool icon-btn label-font-btn" id="labelAlignToggle" title="Wyrównanie etykiety (lewo / środek)" aria-label="Wyrównanie etykiety" aria-pressed="false"></button>
            </div>
            <div class="tool-row label-greek-row" id="labelGreekRow" style="display:none;">
              <button type="button" id="labelGreekShift" class="tool icon-btn label-greek-shift" title="Wielkie litery" aria-label="Wielkie litery" aria-pressed="false">⇧</button>
              <button type="button" id="labelScriptToggle" class="tool icon-btn label-script-toggle" title="Latin script" aria-label="Latin script" aria-pressed="false">A/a</button>
              <!-- Buttons will be generated dynamically -->
            </div>
            <input type="number" id="styleWidth" min="0.1" max="50" step="0.1" value="2" style="display:none">
            <div class="tool-row line-width-row" id="styleWidthRow" style="justify-content:flex-start;">
              <div class="style-group line-width-group">
                <button class="tool icon-btn line-width-btn" id="lineWidthDecrease" title="Zmniejsz grubość" aria-label="Zmniejsz grubość">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="icon-minus"></svg>
                </button>
                <span id="lineWidthValue" class="line-width-value" aria-live="polite">2 px</span>
                <button class="tool icon-btn line-width-btn" id="lineWidthIncrease" title="Zwiększ grubość" aria-label="Zwiększ grubość">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="icon-plus"></svg>
                </button>
              </div>
              <span class="style-row-gap" id="styleTypeGap"></span>
              <div class="style-group" id="styleTypeInline">
                <button class="tool icon-btn type-btn" data-type="solid" title="Linia ciągła">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="line-solid"></svg>
                </button>
                <button class="tool icon-btn type-btn" data-type="dashed" title="Linia przerywana">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="line-dashed"></svg>
                </button>
                <button class="tool icon-btn type-btn" data-type="dotted" title="Linia kropkowana">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="line-dotted"></svg>
                </button>
              </div>
            </div>
            <div class="tool-row" id="styleHighlighterAlphaRow" style="justify-content:flex-start; align-items:center; display:none; gap:8px;">
              <label for="highlighterAlpha" style="margin:0 6px 0 0;">Siła</label>
              <input type="range" id="highlighterAlpha" min="0.02" max="0.6" step="0.02" value="0.14" style="flex:1;">
              <span id="highlighterAlphaValue" style="width:42px; text-align:right;">14%</span>
            </div>
            <select id="styleType" style="display:none">
              <option value="solid">Ciągła</option>
              <option value="dashed">Przerywana</option>
              <option value="dotted">Kropkowana</option>
            </select>
            <div class="tool-row" id="styleTypeRow" style="justify-content:flex-start; margin-top:6px; display:none;">
              <button class="tool icon-btn type-btn" data-type="solid" title="Linia ciągła">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="line-solid"></svg>
              </button>
              <button class="tool icon-btn type-btn" data-type="dashed" title="Linia przerywana">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="line-dashed"></svg>
              </button>
              <button class="tool icon-btn type-btn" data-type="dotted" title="Linia kropkowana">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="line-dotted"></svg>
              </button>
            </div>
            <div class="tool-row" id="styleArcRow" style="justify-content:flex-start; margin-top:6px; display:none;">
              <button class="tool icon-btn" id="angleRadiusDecreaseBtn" title="Zmniejsz promień łuku">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="icon-minus"></svg>
              </button>
              <button class="tool icon-btn" id="angleRadiusIncreaseBtn" title="Zwiększ promień łuku">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="icon-plus"></svg>
              </button>
              <button class="tool icon-btn arc-count-btn" data-count="1" title="Pojedynczy łuk">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="arc-1"></svg>
              </button>
              <button class="tool icon-btn arc-count-btn" data-count="2" title="Podwójny łuk">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="arc-2"></svg>
              </button>
              <button class="tool icon-btn arc-count-btn" data-count="3" title="Potrójny łuk">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="arc-3"></svg>
              </button>
              <button class="tool icon-btn arc-count-btn" data-count="4" title="Wypełnienie">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="arc-fill"></svg>
              </button>
              <button class="tool icon-btn" id="rightAngleBtn" title="Kąt prosty">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="angle-right"></svg>
              </button>
            </div>
          </div>
        </div>
        <div class="label-tools-group">
          <button id="pointLabelsAutoBtn" class="tool icon-btn" title="Wyrównaj etykiety" aria-label="Wyrównaj etykiety" style="display:none;">
            <svg class="icon" viewBox="0 0 64 64" aria-hidden="true" data-icon="label-auto"></svg>
          </button>
          <button id="pointLabelsAwayBtn" class="tool icon-btn" title="Odsuń etykiety" aria-label="Odsuń etykiety" style="display:none;">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="label-away"></svg>
          </button>
          <button id="pointLabelsCloserBtn" class="tool icon-btn" title="Przysuń etykiety" aria-label="Przysuń etykiety" style="display:none;">
            <svg class="icon" viewBox="0 0 64 64" aria-hidden="true" data-icon="label-closer"></svg>
          </button>
          <div class="dropdown" id="labelToolsOverflowContainer" style="display:none;">
            <button id="labelToolsOverflowBtn" class="tool icon-btn icon-btn-ghost" title="Wiecej" aria-label="Wiecej" aria-haspopup="true" aria-expanded="false">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="menu-dots"></svg>
            </button>
            <div class="dropdown-menu" id="labelToolsOverflowMenu" style="min-width:0; width:auto; align-items:flex-start;">
              <div class="tool-row" id="labelToolsOverflowRow" style="justify-content:flex-start;"></div>
            </div>
          </div>
        </div>
        <button id="eraserBtn" class="tool icon-btn" title="Gumka" aria-label="Gumka" aria-pressed="false" style="display:none;">
          <svg width="24px" height="24px" viewBox="0 0 256.00098 256.00098" class="icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" data-icon="eraser"></svg>
        </button>
        <!-- highlighter button moved into handwriting style menu -->
        <button id="hideButton" class="tool icon-btn" title="Ukryj/Pokaż zaznaczone" aria-label="Ukryj/Pokaż zaznaczone" style="display:none;">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="eye-off"></svg>
        </button>
        <button id="copyStyleBtn" class="tool icon-btn" title="Kopiuj/Wklej styl" aria-label="Kopiuj/Wklej styl" aria-pressed="false" style="display:none;">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="copy-style"></svg>
        </button>
        <button id="multiMoveBtn" class="tool icon-btn" title="Przesun zaznaczone" aria-label="Przesun zaznaczone" aria-pressed="false" style="display:none;">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="multi-move"></svg>
        </button>
        <button id="multiHideBtn" class="tool icon-btn" title="Ukryj zaznaczone" aria-label="Ukryj zaznaczone" style="display:none;">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="eye-off"></svg>
        </button>
        <button id="multiCloneBtn" class="tool icon-btn" title="Klonuj zaznaczone" aria-label="Klonuj zaznaczone" style="display:none;">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="multi-clone-copy"></svg>
        </button>
        <button id="cloudFilesBtn" class="tool icon-btn" title="Pliki w chmurze" aria-label="Pliki w chmurze">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-icon="cloud-files"></svg>
        </button>
        
        <button id="exportJsonBtn" class="tool icon-btn" title="Zapisz (CTR)" aria-label="Zapisz (CTR)">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="export-json"></svg>
        </button>
        <button id="bundlePrevBtn" class="tool icon-btn" title="Poprzedni plik" aria-label="Poprzedni plik" style="display:none;" disabled>
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="nav-prev"></svg>
        </button>
        <button id="bundleNextBtn" class="tool icon-btn" title="Następny plik" aria-label="Następny plik" style="display:none;" disabled>
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="nav-next"></svg>
        </button>
        <button id="deletePoint" class="tool icon-btn" title="Usuń zaznaczone" aria-label="Usuń zaznaczone" style="display:none;">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="delete"></svg>
        </button>
        </div>
        <div class="topbar-right">
        <button id="undo" class="tool icon-btn icon-btn-ghost" title="Cofnij" aria-label="Cofnij">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="undo"></svg>
        </button>
        <button id="redo" class="tool icon-btn icon-btn-ghost" title="Ponów" aria-label="Ponów">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="redo"></svg>
        </button>
        <div class="dropdown" id="optionsMenuContainer">
          <button id="zoomMenu" class="tool icon-btn icon-btn-ghost" title="Opcje" aria-label="Opcje">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="menu-lines"></svg>
          </button>
          <div class="dropdown-menu options-menu">
            <button id="clearAll" class="tool icon-btn" title="Wyczyść wszystko" aria-label="Wyczyść wszystko">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="delete"></svg>
            </button>
            <button id="showHiddenBtn" class="tool icon-btn" title="Pokaż ukryte" aria-label="Pokaż ukryte"></button>
            <button id="showMeasurementsBtn" class="tool icon-btn" title="Pokaż wymiary" aria-label="Pokaż wymiary" aria-pressed="false">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="measure"></svg>
            </button>
            <button id="copyImageBtn" class="tool icon-btn" title="Kopiuj obraz (PNG)" aria-label="Kopiuj obraz">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="copy-image"></svg>
            </button>
            <button id="saveImageBtn" class="tool icon-btn" title="Zapisz PNG" aria-label="Zapisz PNG">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="save-image"></svg>
            </button>
            <button id="invertColorsBtn" class="tool icon-btn" title="Odwróć kolory" aria-label="Odwróć kolory">
              <svg class="icon" viewBox="0 0 64 64" aria-hidden="true" data-icon="invert-colors"></svg>
            </button>
            <button id="debugToggle" class="tool icon-btn" title="Lista obiektów" aria-label="Debug">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="debug-list"></svg>
            </button>
            <button id="settingsBtn" class="tool icon-btn" title="Konfiguracja" aria-label="Konfiguracja">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="settings"></svg>
            </button>
            <button id="helpBtn" class="tool icon-btn" title="Pomoc" aria-label="Pomoc">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="help"></svg>
            </button>
            <button id="themeDark" class="tool icon-btn" title="Tryb ciemny" aria-pressed="true">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="theme-dark"></svg>
            </button>
          </div>
        </div>
        </div>
      </div>
    </div>
    <div class="canvas-wrap">
      <canvas id="canvas"></canvas>
    </div>
    <div id="hintBar" aria-live="polite" style="padding:8px 12px; font-size:13px; color:var(--fg-secondary); background:transparent; min-height:20px;"></div>
    <div id="debugPanel" class="debug-panel" role="dialog" aria-label="Panel debug" aria-modal="false">
      <div id="debugPanelHandle" class="debug-panel__header">
        <span class="debug-panel__title">Lista obiektów</span>
        <button id="debugCloseBtn" class="debug-panel__close" type="button" aria-label="Zamknij panel debug">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="close"></svg>
        </button>
      </div>
      <div id="debugContent" class="debug-panel__content"></div>
    </div>
    <div id="cloudPanel" class="debug-panel" role="dialog" aria-label="Pliki" aria-modal="false" style="left: 16px; top: 16px; z-index: 220; width: 520px;">
      <div id="cloudPanelHandle" class="debug-panel__header">
        <span class="debug-panel__title" id="cloudPanelTitle">Pliki</span>
        <div id="cloudToolbarHeader" style="display: none;"></div>
        <button id="cloudCloseBtn" class="debug-panel__close" type="button" aria-label="Zamknij panel plików">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="close"></svg>
        </button>
      </div>
      <div class="debug-panel__content">
        <div class="cloud-tabs">
          <button class="cloud-tab cloud-tab--active" data-tab="local">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="cloud-tab-local"></svg>
            Lokalne
          </button>
          <button class="cloud-tab" data-tab="library">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="cloud-tab-library"></svg>
            Biblioteka
          </button>
          <button class="cloud-tab" data-tab="cloud">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="cloud-tab-cloud"></svg>
            Chmura
          </button>
        </div>
        <div class="cloud-content">
          <div class="cloud-list" id="localFileList">
            <div class="cloud-loading">Ładowanie...</div>
          </div>
          <div class="cloud-list" id="libraryFileList" style="display: none;">
            <div class="cloud-loading">Ładowanie...</div>
          </div>
          <div class="cloud-list" id="cloudFileList" style="display: none;">
            <div class="cloud-loading">Ładowanie...</div>
          </div>
        </div>
        <div id="cloudSaveBar" class="cloud-save-bar" style="display:none; padding:12px 0 0; margin-top:12px; border-top:1px solid rgba(255,255,255,0.1); gap:8px; align-items:center;">
          <label for="cloudFilenameInput" style="font-size:13px; color:var(--text-muted, #d1d5db); white-space:nowrap;">Nazwa pliku</label>
          <input id="cloudFilenameInput" type="text" placeholder="nazwa pliku" style="flex:1; min-width:120px; padding:6px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:transparent; color:inherit; font-size:14px;">
          <button id="cloudSaveBtn" class="tool icon-btn" style="padding:8px 18px; font-weight:600;">ZAPISZ</button>
        </div>
      </div>
    </div>
    <div class="toolbar toolbar-bare toolbar-bottom">
      <div class="tool-row tool-row-second" id="toolbarSecondRow" style="justify-content:center; display:none;">
      </div>
      <div class="tool-row" id="toolbarMainRow" style="justify-content:center;">
        <button id="modeMove" class="tool icon-btn" title="Zaznacz" aria-label="Zaznacz">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Zaznacz</span>
        </button>
        <button id="modeMultiselect" class="tool icon-btn" title="Zaznacz wiele" aria-label="Zaznacz wiele">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Zaznacz wiele</span>
        </button>
        <button id="modeLabel" class="tool icon-btn" title="Etykieta" aria-label="Etykieta">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Etykieta</span>
        </button>
        <button id="modeAdd" class="tool icon-btn" title="Dodaj punkt" aria-label="Punkt">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Punkt</span>
        </button>
        <button id="modeIntersection" class="tool icon-btn" title="Punkt przecięcia" aria-label="Punkt przecięcia">
          <svg class="icon" viewBox="0 0 64 64" aria-hidden="true"></svg>
          <span class="sr-only">Punkt przecięcia</span>
        </button>
        <button id="modeSegment" class="tool icon-btn" title="Odcinek" aria-label="Odcinek">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Odcinek</span>
        </button>
        <button id="modeParallel" class="tool icon-btn" title="Równoległa" aria-label="Równoległa">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Równoległa</span>
        </button>
        <button id="modePerpendicular" class="tool icon-btn" title="Prostopadła" aria-label="Prostopadła">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Prostopadła</span>
        </button>
                <button id="modeCircle" class="tool icon-btn" title="Okrąg" aria-label="Okrąg">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Okrąg</span>
        </button>
        <button id="modeCircleThree" class="tool icon-btn" title="Okrąg przez 3 punkty" aria-label="Okrąg przez 3 punkty">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Okrąg przez 3 punkty</span>
        </button>

        <button id="modeTriangleUp" class="tool icon-btn" title="Trójkąt foremny" aria-label="Trójkąt foremny">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Trójkąt foremny</span>
        </button>
        <button id="modeSquare" class="tool icon-btn" title="Kwadrat" aria-label="Kwadrat">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Kwadrat</span>
        </button>
        <button id="modeNgon" class="tool icon-btn" title="n-gon" aria-label="n-gon">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">n-gon</span>
        </button>
        <button id="modePolygon" class="tool icon-btn" title="Wielokąt" aria-label="Wielokąt">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Wielokąt</span>
        </button>
        <button id="modeAngle" class="tool icon-btn" title="Kąt" aria-label="Kąt">
          <svg class="icon" viewBox="0 0 64 64" aria-hidden="true"></svg>
          <span class="sr-only">Kąt</span>
        </button>
        <button id="modeBisector" class="tool icon-btn" title="Dwusieczna" aria-label="Dwusieczna">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Dwusieczna</span>
        </button>
        <button id="modeMidpoint" class="tool icon-btn" title="Punkt środkowy" aria-label="Punkt środkowy">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Punkt środkowy</span>
        </button>
        <button id="modeSymmetric" class="tool icon-btn" title="Punkt symetryczny" aria-label="Punkt symetryczny">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Punkt symetryczny</span>
        </button>
        <button id="modeTangent" class="tool icon-btn" title="Styczna" aria-label="Styczna">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Styczna</span>
        </button>
        <button id="modePerpBisector" class="tool icon-btn" title="Symetralna" aria-label="Symetralna">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Symetralna</span>
        </button>
        <button id="modeHandwriting" class="tool icon-btn" title="Pismo odręczne" aria-label="Pismo odręczne">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
          <span class="sr-only">Pismo odręczne</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" style="display:none;">
    <div class="modal-content settings-modal">
      <div class="modal-header">
        <h2 id="settingsTitle">Konfiguracja</h2>
        <div id="languageProminent" style="display:flex; align-items:center; gap:8px; margin-left:12px;">
          <svg class="icon" viewBox="0 0 64 64" role="img" aria-label="Change language" style="width:18px;height:18px;opacity:0.95" data-icon="language"></svg>
          <select id="languageSelectProminent" style="padding:6px 8px; border-radius:6px; font-weight:600;">
            <option value="pl">Polski</option>
            <option value="en">English</option>
          </select>
        </div>
        <button id="settingsCloseBtn" class="icon-btn" title="Zamknij" aria-label="Zamknij">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="close"></svg>
        </button>
      </div>
      <div class="modal-tabs">
        <button id="tabBtnGeneral" class="tab-btn active" data-tab="general">Ogólne</button>
        <button id="tabBtnButtons" class="tab-btn" data-tab="buttons">Przyciski</button>
        <button id="tabBtnAppearance" class="tab-btn" data-tab="appearance">Wygląd</button>
      </div>
      <div class="modal-body">
        <div id="tabGeneral" class="tab-content active">
          
          <div class="config-section" style="margin-top: 16px;">
            <div style="padding: 12px;">
              <h3 data-i18n="precisionTitle">Precyzja wymiarów</h3>
              <div style="display: flex; gap: 24px; margin-top: 16px;">
                <div style="flex: 1;">
                  <label for="precisionLength" data-i18n="precisionLengthLabel" style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--fg-secondary);">
                    Długości:
                  </label>
                  <input type="number" id="precisionLength" min="0" max="5" value="0" 
                         style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--fg);">
                </div>
                <div style="flex: 1;">
                  <label for="precisionAngle" data-i18n="precisionAngleLabel" style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--fg-secondary);">
                    Kątów:
                  </label>
                  <input type="number" id="precisionAngle" min="0" max="5" value="0"
                         style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--fg);">
                </div>
              </div>
            </div>
          <div class="config-section" style="margin-top: 16px;">
            <div style="padding: 12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
              <label for="showHintsToggle" style="display:flex; align-items:center; gap:10px; font-size:14px; color:var(--fg);">
                <input type="checkbox" id="showHintsToggle" checked>
                <span id="showHintsLabel">Pokaż podpowiedzi</span>
              </label>
              <label for="autoStyleMenuToggle" style="display:flex; align-items:center; gap:10px; font-size:14px; color:var(--fg);">
                <input type="checkbox" id="autoStyleMenuToggle">
                <span id="autoStyleMenuLabel">Automatycznie otwieraj styl</span>
              </label>
              <!-- old inline language selector removed; use prominent header selector -->
              <div style="color:var(--fg-secondary); font-size:13px;"></div>
            </div>
          </div>
          </div>
          <div class="config-section" style="margin-top: 16px;">
            <div style="padding: 12px;">
              <h3 data-i18n="exportImportTitle">Eksport i Import</h3>
              <p class="tab-description" data-i18n="exportImportDesc">Zapisz lub wczytaj pełną konfigurację aplikacji.</p>
              <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button id="exportConfigBtn" class="icon-btn" title="Eksportuj konfigurację" style="padding: 10px 16px; font-size: 14px; flex: 1;">
                  <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 6px;" data-icon="config-export"></svg>
                  <span id="exportConfigText">Eksportuj konfigurację</span>
                </button>
                <button id="importConfigBtn" class="icon-btn" title="Importuj konfigurację" style="padding: 10px 16px; font-size: 14px; flex: 1;">
                  <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 6px;" data-icon="config-import"></svg>
                  <span id="importConfigText">Importuj konfigurację</span>
                </button>
                <input type="file" id="importConfigInput" accept=".json" style="display: none;">
              </div>
            </div>
          </div>
        </div>
        <div id="tabButtons" class="tab-content">
          <div class="config-section">
            <div id="multiButtonConfig" class="button-config-area">
              <!-- Dynamic content will be added here -->
            </div>
          </div>
        </div>
        <div id="tabAppearance" class="tab-content">
          <div class="appearance-config">
            <div class="appearance-controls">
              <div class="appearance-theme-toggle">
                <button class="theme-btn active" data-theme="dark" data-i18n="themeDarkText">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="theme-dark"></svg>
                  Ciemny
                </button>
                <button class="theme-btn" data-theme="light" data-i18n="themeLightText">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="theme-light"></svg>
                  Jasny
                </button>
              </div>
              
              <div class="config-section">
                <h3 data-i18n="defaultColorsTitle">Domyślne kolory</h3>
                <div class="config-row">
                  <label for="themeBgColor" data-i18n="themeBgLabel">Kolor tła:</label>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <input type="color" id="themeBgColor" class="color-input">
                    <input type="text" id="themeBgColorHex" class="color-hex" placeholder="#rrggbb" maxlength="7">
                  </div>
                </div>
                <div class="config-row">
                  <label for="themePanelColor" data-i18n="themePanelLabel">Kolor okna:</label>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <input type="color" id="themePanelColor" class="color-input">
                    <input type="text" id="themePanelColorHex" class="color-hex" placeholder="#rrggbb" maxlength="7">
                  </div>
                </div>
                <div class="config-row">
                  <label for="themeStrokeColor" data-i18n="themeStrokeLabel">Kolor linii:</label>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <input type="color" id="themeStrokeColor" class="color-input">
                    <input type="text" id="themeStrokeColorHex" class="color-hex" placeholder="#rrggbb" maxlength="7">
                  </div>
                </div>
                <div class="config-row">
                  <label for="themeHighlightColor" data-i18n="themeHighlightLabel">Kolor zaznaczenia:</label>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <input type="color" id="themeHighlightColor" class="color-input">
                    <input type="text" id="themeHighlightColorHex" class="color-hex" placeholder="#rrggbb" maxlength="7">
                  </div>
                </div>
                <div class="config-row">
                  <label for="themeSelectionLineStyle" data-i18n="themeSelectionLineStyleLabel">Styl linii zaznaczenia:</label>
                  <select id="themeSelectionLineStyle" class="config-select" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--fg);">
                    <option value="auto">Bez zmian</option>
                    <option value="dashed">Przerywana</option>
                    <option value="dotted">Kropkowana</option>
                  </select>
                </div>
                <div class="config-row">
                  <label for="themeSelectionEffect" data-i18n="themeSelectionEffectLabel">Efekt zaznaczenia:</label>
                  <select id="themeSelectionEffect" class="config-select" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--fg);">
                    <option value="color">Kolor</option>
                    <option value="halo">Poświata</option>
                  </select>
                </div>
                <div class="config-row">
                  <div data-i18n="themeHighlightWidthLabel" style="font-size:14px; color:var(--fg);">Szerokość zaznaczenia:</div>
                  <div class="size-control">
                    <button class="size-btn" data-action="decrease" data-target="highlightWidth">−</button>
                    <span class="size-value" id="themeHighlightWidthValue">3 px</span>
                    <button class="size-btn" data-action="increase" data-target="highlightWidth">+</button>
                  </div>
                </div>
                <div class="config-row">
                  <label for="themeSelectionPointStyleSameAsLine" data-i18n="themeSelectionPointStyleSameAsLine">Styl punktu jak linii:</label>
                  <input type="checkbox" id="themeSelectionPointStyleSameAsLine" style="width: 20px; height: 20px;">
                </div>
                <div class="config-row">
                  <div data-i18n="themeSelectionPointRadiusLabel" style="font-size:14px; color:var(--fg);">Promień zaznaczenia punktu:</div>
                  <div class="size-control">
                    <button class="size-btn" data-action="decrease" data-target="selectionPointRadius">−</button>
                    <span class="size-value" id="themeSelectionPointRadiusValue">8 px</span>
                    <button class="size-btn" data-action="increase" data-target="selectionPointRadius">+</button>
                  </div>
                </div>

              </div>

              <div class="config-section">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                  <div style="font-size: 14px; color: var(--fg); margin:0;">Styl punktów</div>
                  <button type="button" id="pointStyleToggleBtn" class="tool icon-btn" aria-pressed="false" title="Styl punktów">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="point-hollow"></svg>
                  </button>
                </div>
              </div>

              <div class="appearance-preview">
                <h3 data-i18n="previewTitle">Podgląd</h3>
                <div class="preview-canvas-wrapper">
                  <canvas id="previewCanvas" width="400" height="400"></canvas>
                </div>
              </div>

              <div class="config-section">
                <h3 data-i18n="defaultSizesTitle">Domyślne rozmiary</h3>
                <div class="config-row">
                  <div data-i18n="themeLineWidthLabel" style="font-size:14px; color:var(--fg);">Grubość linii:</div>
                  <div class="size-control">
                    <button class="size-btn" data-action="decrease" data-target="lineWidth">−</button>
                    <span class="size-value" id="themeLineWidthValue">2 px</span>
                    <button class="size-btn" data-action="increase" data-target="lineWidth">+</button>
                  </div>
                </div>
                <div class="config-row">
                  <div data-i18n="themePointSizeLabel" style="font-size:14px; color:var(--fg);">Rozmiar punktu:</div>
                  <div class="size-control">
                    <button class="size-btn" data-action="decrease" data-target="pointSize">−</button>
                    <span class="size-value" id="themePointSizeValue">8 px</span>
                    <button class="size-btn" data-action="increase" data-target="pointSize">+</button>
                  </div>
                </div>
                <div class="config-row">
                  <div data-i18n="themeArcRadiusLabel" style="font-size:14px; color:var(--fg);">Promień łuku kąta:</div>
                  <div class="size-control">
                    <button class="size-btn" data-action="decrease" data-target="arcRadius">−</button>
                    <span class="size-value" id="themeArcRadiusValue">24 px</span>
                    <button class="size-btn" data-action="increase" data-target="arcRadius">+</button>
                  </div>
                </div>
                <div class="config-row">
                  <div data-i18n="themeLabelFontSize" style="font-size:14px; color:var(--fg);">Rozmiar czcionki etykiet:</div>
                  <div class="size-control">
                    <button class="size-btn" data-action="decrease" data-target="fontSize">−</button>
                    <span class="size-value" id="themeFontSizeValue">16 px</span>
                    <button class="size-btn" data-action="increase" data-target="fontSize">+</button>
                  </div>
                </div>

              </div>

              <div class="config-section">
                <button id="resetThemeDefaults" class="icon-btn" style="width: 100%; padding: 12px;">
                  Przywróć domyślne
                </button>
              </div>
            </div>
            
            <!-- preview moved earlier (after colors, before sizes) -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- N-gon Modal -->
  <div id="ngonModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 320px;">
      <div class="modal-header">
        <h2>Liczba boków</h2>
        <button id="ngonCloseBtn" class="icon-btn" title="Zamknij" aria-label="Zamknij">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" data-icon="close"></svg>
        </button>
      </div>
      <div class="modal-body" style="padding: 16px;">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
          <button class="ngon-preset-btn tool icon-btn" data-n="5" style="width: 100%; justify-content: center;">5</button>
          <button class="ngon-preset-btn tool icon-btn" data-n="6" style="width: 100%; justify-content: center;">6</button>
          <button class="ngon-preset-btn tool icon-btn" data-n="7" style="width: 100%; justify-content: center;">7</button>
          <button class="ngon-preset-btn tool icon-btn" data-n="8" style="width: 100%; justify-content: center;">8</button>
          <button class="ngon-preset-btn tool icon-btn" data-n="12" style="width: 100%; justify-content: center;">12</button>
          <button class="ngon-preset-btn tool icon-btn" data-n="18" style="width: 100%; justify-content: center;">18</button>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <label for="ngonInput" style="white-space: nowrap;">n =</label>
          <input type="number" id="ngonInput" min="3" max="100" value="9" style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--fg-primary);">
          <button id="ngonConfirmBtn" class="icon-btn" style="padding: 8px 16px; background: var(--accent-color); color: white;">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="/src/main.ts"></script>
  <div id="swUpdateToast" class="sw-toast" aria-live="polite" style="display:none; position:fixed; left:50%; transform:translateX(-50%); bottom:20px; z-index:100; width:min(420px, 92vw);">
    <div class="sw-toast__inner">
      <span id="swUpdateText" class="sw-toast__message">Nowa wersja dostępna</span>
      <div class="sw-toast__actions">
        <button id="swUpdateBtn" class="sw-toast__button">Zastosuj</button>
        <button id="swDismissBtn" class="sw-toast__button sw-toast__button--ghost">Później</button>
      </div>
    </div>
  </div>
  <!-- Service worker registration + update prompt are handled in /src/main.ts to avoid duplicate registrations -->
</body>
</html>
